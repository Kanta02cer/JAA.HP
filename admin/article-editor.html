<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記事編集 - JAA CMS</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="../js/toast-notifications.js"></script>
    <script src="../js/github-sync.js"></script>
    <!-- Quill.js リッチエディタ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body class="bg-gray-50 font-['Inter','Noto_Sans_JP',sans-serif]">
    <!-- ヘッダー -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="cms-dashboard.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>ダッシュボードに戻る
                    </a>
                    <h1 class="text-xl font-bold text-gray-900">記事編集</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="text-sm text-gray-700"></span>
                    <div class="flex space-x-2">
                        <button id="save-draft-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-700">
                            <i class="fas fa-save mr-2"></i>下書き保存
                        </button>
                        <button id="preview-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-eye mr-2"></i>プレビュー
                        </button>
                        <button id="publish-btn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">
                            <i class="fas fa-paper-plane mr-2"></i>公開
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左側: 記事編集 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 基本情報 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">基本情報</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">記事タイトル *</label>
                            <input type="text" id="article-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="記事のタイトルを入力してください" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">記事説明</label>
                            <textarea id="article-excerpt" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="記事の要約や説明を入力してください"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">カテゴリ *</label>
                                <select id="article-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">カテゴリを選択</option>
                                    <option value="プレスリリース">プレスリリース</option>
                                    <option value="メディア掲載">メディア掲載</option>
                                    <option value="イベント">イベント</option>
                                    <option value="お知らせ">お知らせ</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">公開日</label>
                                <input type="date" id="publish-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">タグ</label>
                            <input type="text" id="article-tags" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="カンマ区切りでタグを入力（例: 学生, 就職, イベント）">
                        </div>
                    </div>
                </div>

                <!-- トップ画像 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">トップ画像</h3>
                    </div>
                    <div class="p-6">
                        <div id="image-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
                            <input type="file" id="featured-image" accept="image/*" class="hidden">
                            <div id="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">クリックして画像をアップロード</p>
                                <p class="text-sm text-gray-500 mt-2">推奨サイズ: 1200x630px (最大5MB)</p>
                            </div>
                            <div id="image-preview" class="hidden">
                                <img id="preview-image" class="max-w-full h-auto rounded-lg shadow-md">
                                <button id="remove-image" class="mt-2 bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                    <i class="fas fa-trash mr-1"></i>画像を削除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 記事本文 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">記事本文</h3>
                    </div>
                    <div class="p-6">
                        <div id="editor-container" class="min-h-[400px]"></div>
                    </div>
                </div>

                <!-- SEO設定 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">SEO設定</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">メタタイトル</label>
                            <input type="text" id="meta-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="検索エンジン用のタイトル">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">メタ説明</label>
                            <textarea id="meta-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="検索エンジン用の説明文"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">キーワード</label>
                            <input type="text" id="meta-keywords" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="カンマ区切りでキーワードを入力">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側: プレビュー・設定 -->
            <div class="space-y-6">
                <!-- プレビュー -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">プレビュー</h3>
                    </div>
                    <div class="p-6">
                        <div id="preview-content" class="prose max-w-none">
                            <p class="text-gray-500 text-center">プレビューを表示するには「プレビュー」ボタンをクリックしてください</p>
                        </div>
                    </div>
                </div>

                <!-- 公開設定 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">公開設定</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ステータス</label>
                            <select id="article-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="draft">下書き</option>
                                <option value="published">公開</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">URLスラッグ</label>
                            <input type="text" id="article-slug" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="自動生成されます">
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="featured-article" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="featured-article" class="ml-2 block text-sm text-gray-900">注目記事として表示</label>
                        </div>
                    </div>
                </div>

                <!-- 記事情報 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">記事情報</h3>
                    </div>
                    <div class="p-6 space-y-2 text-sm text-gray-600">
                        <div>作成者: <span id="article-author">-</span></div>
                        <div>作成日: <span id="article-created">-</span></div>
                        <div>更新日: <span id="article-updated">-</span></div>
                        <div>文字数: <span id="article-word-count">0</span></div>
                        <div>読み取り時間: <span id="article-read-time">約0分</span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- プレビューモーダル -->
    <div id="preview-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">記事プレビュー</h3>
                    <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="modal-preview-content" class="max-h-96 overflow-y-auto">
                    <!-- プレビュー内容がここに表示されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">処理中...</span>
            </div>
        </div>
    </div>



    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyDUm0XzV9wPIHJSTsKiJ9LXqjlIA81l1Rc",
            authDomain: "jaa-hp.firebaseapp.com",
            projectId: "jaa-hp",
            storageBucket: "jaa-hp.appspot.com",
            messagingSenderId: "549447513177",
            appId: "1:549447513177:web:2f2fc2f9bfe0ddd29d6d48",
            measurementId: "G-JLRH848YQS"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // グローバル変数
        let currentUser = null;
        let quill = null;
        let currentArticleId = null;
        let autoSaveTimer = null;
        let uploadedImageUrl = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            initializeEditor();
            setupEventListeners();
            initializeForm();
        });

        // 認証初期化
        function initializeAuth() {
            auth.onAuthStateChanged(function(user) {
                if (user && user.emailVerified) {
                    currentUser = user;
                    document.getElementById('user-info').textContent = `${user.email} (認証済み)`;
                    loadArticleIfEditing();
                } else {
                    window.location.href = 'news-console.html';
                }
            });
        }

        // エディタ初期化
        function initializeEditor() {
            const toolbarOptions = [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ];

            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions
                },
                placeholder: '記事の内容を入力してください...'
            });

            // エディタの内容変更を監視
            quill.on('text-change', function() {
                updateWordCount();
                scheduleAutoSave();
            });
        }

        // イベントリスナー設定
        function setupEventListeners() {
            document.getElementById('save-draft-btn').addEventListener('click', saveDraft);
            document.getElementById('preview-btn').addEventListener('click', showPreview);
            document.getElementById('publish-btn').addEventListener('click', publishArticle);
            
            // 画像アップロード
            document.getElementById('image-upload-area').addEventListener('click', () => {
                document.getElementById('featured-image').click();
            });
            document.getElementById('featured-image').addEventListener('change', handleImageUpload);
            document.getElementById('remove-image').addEventListener('click', removeImage);
            
            // フォーム入力監視
            document.getElementById('article-title').addEventListener('input', scheduleAutoSave);
            document.getElementById('article-excerpt').addEventListener('input', scheduleAutoSave);
            document.getElementById('article-category').addEventListener('change', scheduleAutoSave);
            document.getElementById('publish-date').addEventListener('change', scheduleAutoSave);
            document.getElementById('article-tags').addEventListener('input', scheduleAutoSave);
            document.getElementById('meta-title').addEventListener('input', scheduleAutoSave);
            document.getElementById('meta-description').addEventListener('input', scheduleAutoSave);
            document.getElementById('meta-keywords').addEventListener('input', scheduleAutoSave);
            document.getElementById('article-status').addEventListener('change', scheduleAutoSave);
            document.getElementById('featured-article').addEventListener('change', scheduleAutoSave);
        }

        // フォーム初期化
        function initializeForm() {
            // 今日の日付を設定
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('publish-date').value = today;
            
            // タイトルからスラッグを自動生成
            document.getElementById('article-title').addEventListener('input', function() {
                const title = this.value;
                const slug = generateSlug(title);
                document.getElementById('article-slug').value = slug;
            });
        }

        // 編集モードで記事を読み込み
        async function loadArticleIfEditing() {
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');
            
            if (articleId) {
                currentArticleId = articleId;
                await loadArticle(articleId);
            }
        }

        // 記事読み込み
        async function loadArticle(articleId) {
            showLoading();
            try {
                const doc = await db.collection('news').doc(articleId).get();
                if (doc.exists) {
                    const article = doc.data();
                    populateForm(article);
                    showSuccess('記事を読み込みました');
                } else {
                    showError('記事が見つかりません');
                }
            } catch (error) {
                console.error('記事読み込みエラー:', error);
                showError('記事の読み込みに失敗しました');
            } finally {
                hideLoading();
            }
        }

        // フォームに記事データを設定
        function populateForm(article) {
            document.getElementById('article-title').value = article.title || '';
            document.getElementById('article-excerpt').value = article.excerpt || '';
            document.getElementById('article-category').value = article.category || '';
            document.getElementById('publish-date').value = article.publishDate ? new Date(article.publishDate.toDate()).toISOString().split('T')[0] : '';
            document.getElementById('article-tags').value = article.tags ? article.tags.join(', ') : '';
            document.getElementById('article-status').value = article.status || 'draft';
            document.getElementById('article-slug').value = article.slug || '';
            document.getElementById('featured-article').checked = article.featured || false;
            
            // SEO設定
            if (article.seo) {
                document.getElementById('meta-title').value = article.seo.metaTitle || '';
                document.getElementById('meta-description').value = article.seo.metaDescription || '';
                document.getElementById('meta-keywords').value = article.seo.keywords ? article.seo.keywords.join(', ') : '';
            }
            
            // エディタに内容を設定
            if (article.content) {
                quill.root.innerHTML = article.content;
            }
            
            // 画像を設定
            if (article.featuredImage) {
                uploadedImageUrl = article.featuredImage;
                showImagePreview(article.featuredImage);
            }
            
            // 記事情報を更新
            updateArticleInfo();
        }

        // 画像アップロード処理
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ファイルサイズチェック (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError('ファイルサイズは5MB以下にしてください');
                return;
            }

            // ファイルタイプチェック
            if (!file.type.startsWith('image/')) {
                showError('画像ファイルを選択してください');
                return;
            }

            showLoading();
            try {
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`articles/${Date.now()}_${file.name}`);
                const snapshot = await imageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                uploadedImageUrl = downloadURL;
                showImagePreview(downloadURL);
                showSuccess('画像がアップロードされました');
            } catch (error) {
                console.error('画像アップロードエラー:', error);
                showError('画像のアップロードに失敗しました');
            } finally {
                hideLoading();
            }
        }

        // 画像プレビュー表示
        function showImagePreview(imageUrl) {
            document.getElementById('upload-placeholder').classList.add('hidden');
            document.getElementById('image-preview').classList.remove('hidden');
            document.getElementById('preview-image').src = imageUrl;
        }

        // 画像削除
        function removeImage() {
            uploadedImageUrl = null;
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('featured-image').value = '';
        }

        // 下書き保存
        async function saveDraft() {
            await saveArticle('draft');
        }

        // 記事公開
        async function publishArticle() {
            if (!validateForm()) {
                return;
            }
            await saveArticle('published');
        }

        // 記事保存
        async function saveArticle(status) {
            showLoading();
            try {
                const articleData = collectFormData();
                articleData.status = status;
                articleData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

                if (currentArticleId) {
                    // 既存記事の更新
                    await db.collection('news').doc(currentArticleId).update(articleData);
                    showSuccess('記事が更新されました');
                } else {
                    // 新規記事の作成
                    articleData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    articleData.author = currentUser.email;
                    const docRef = await db.collection('news').add(articleData);
                    currentArticleId = docRef.id;
                    showSuccess('記事が作成されました');
                }

                // URLを更新
                if (!currentArticleId) {
                    window.history.replaceState({}, '', `?id=${currentArticleId}`);
                }

                // 記事情報を更新
                updateArticleInfo();
                
                // 公開の場合はGitHub同期
                if (status === 'published') {
                    await syncWithGitHub();
                }

            } catch (error) {
                console.error('記事保存エラー:', error);
                showError('記事の保存に失敗しました');
            } finally {
                hideLoading();
            }
        }

        // フォームデータ収集
        function collectFormData() {
            const title = document.getElementById('article-title').value;
            const tags = document.getElementById('article-tags').value
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);

            return {
                title: title,
                excerpt: document.getElementById('article-excerpt').value,
                category: document.getElementById('article-category').value,
                publishDate: document.getElementById('publish-date').value,
                tags: tags,
                slug: document.getElementById('article-slug').value || generateSlug(title),
                content: quill.root.innerHTML,
                featuredImage: uploadedImageUrl,
                featured: document.getElementById('featured-article').checked,
                seo: {
                    metaTitle: document.getElementById('meta-title').value,
                    metaDescription: document.getElementById('meta-description').value,
                    keywords: document.getElementById('meta-keywords').value
                        .split(',')
                        .map(keyword => keyword.trim())
                        .filter(keyword => keyword.length > 0)
                }
            };
        }

        // フォームバリデーション
        function validateForm() {
            const title = document.getElementById('article-title').value.trim();
            const category = document.getElementById('article-category').value;
            const content = quill.getText().trim();

            if (!title) {
                showError('記事タイトルを入力してください');
                return false;
            }

            if (!category) {
                showError('カテゴリを選択してください');
                return false;
            }

            if (!content) {
                showError('記事内容を入力してください');
                return false;
            }

            return true;
        }

        // プレビュー表示
        function showPreview() {
            const articleData = collectFormData();
            const previewHTML = generatePreviewHTML(articleData);
            
            document.getElementById('modal-preview-content').innerHTML = previewHTML;
            document.getElementById('preview-modal').classList.remove('hidden');
        }

        // プレビューモーダルを閉じる
        function closePreviewModal() {
            document.getElementById('preview-modal').classList.add('hidden');
        }

        // プレビューHTML生成
        function generatePreviewHTML(articleData) {
            const date = articleData.publishDate ? new Date(articleData.publishDate) : new Date();
            const formattedDate = date.toLocaleDateString('ja-JP');

            return `
                <div class="max-w-4xl mx-auto">
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-8 rounded-lg mb-6">
                        <div class="text-center">
                            <div class="mb-4">
                                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">${formattedDate}</span>
                                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm ml-2">${articleData.category}</span>
                            </div>
                            <h1 class="text-3xl font-bold mb-4">${articleData.title}</h1>
                            ${articleData.excerpt ? `<p class="text-lg opacity-90">${articleData.excerpt}</p>` : ''}
                        </div>
                    </div>
                    
                    ${articleData.featuredImage ? `
                        <div class="mb-6">
                            <img src="${articleData.featuredImage}" alt="${articleData.title}" class="w-full h-auto rounded-lg shadow-lg">
                        </div>
                    ` : ''}
                    
                    <div class="prose max-w-none">
                        ${articleData.content}
                    </div>
                    
                    <div class="mt-8 p-6 bg-gray-50 rounded-lg">
                        <div class="text-center text-gray-600">
                            <p>日本学生アンバサダー協会 公式リリース編集部</p>
                            ${articleData.tags.length > 0 ? `
                                <div class="mt-2">
                                    <span class="text-sm">タグ: </span>
                                    ${articleData.tags.map(tag => `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-1">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // 自動保存スケジュール
        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => {
                if (currentArticleId) {
                    saveArticle(document.getElementById('article-status').value);
                }
            }, 30000); // 30秒後に自動保存
        }

        // 文字数カウント更新
        function updateWordCount() {
            const text = quill.getText();
            const wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const readTime = Math.ceil(wordCount / 400); // 1分400文字として計算
            
            document.getElementById('article-word-count').textContent = wordCount;
            document.getElementById('article-read-time').textContent = `約${readTime}分`;
        }

        // 記事情報更新
        function updateArticleInfo() {
            if (currentUser) {
                document.getElementById('article-author').textContent = currentUser.email;
            }
            
            const now = new Date();
            document.getElementById('article-updated').textContent = now.toLocaleDateString('ja-JP');
            
            if (!currentArticleId) {
                document.getElementById('article-created').textContent = now.toLocaleDateString('ja-JP');
            }
        }

        // スラッグ生成
        function generateSlug(title) {
            return title
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        // GitHub同期
        async function syncWithGitHub() {
            try {
                // 現在の記事を保存してから同期
                if (currentArticleId) {
                    await saveArticle(document.getElementById('article-status').value);
                }
                
                // GitHub同期を実行
                await githubSync.startSync();
            } catch (error) {
                console.error('GitHub同期エラー:', error);
                showError('GitHubとの同期に失敗しました');
            }
        }

        // ユーティリティ関数
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showSuccess(message) {
            toastNotifications.success(message);
        }

        function showError(message) {
            toastNotifications.error(message);
        }

        function showWarning(message) {
            toastNotifications.warning(message);
        }

        function showInfo(message) {
            toastNotifications.info(message);
        }
    </script>
</body>
</html>
