<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS Debug - 日本学生アンバサダー協会</title>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .debug-header {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .debug-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .debug-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .debug-content {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .status-success {
            color: #16a34a;
            font-weight: 600;
        }
        .status-error {
            color: #dc2626;
            font-weight: 600;
        }
        .status-warning {
            color: #d97706;
            font-weight: 600;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="debug-container">
        <div class="debug-header">
            <h1>CMS Debug 情報</h1>
            <p>Netlify CMS の動作状況を確認します</p>
        </div>

        <div class="debug-section">
            <div class="debug-title">1. ページ情報</div>
            <div class="debug-content" id="page-info">読み込み中...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">2. CMS 読み込み状況</div>
            <div class="debug-content" id="cms-status">読み込み中...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">3. 設定ファイル確認</div>
            <div class="debug-content" id="config-status">読み込み中...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">4. エラーログ</div>
            <div class="debug-content" id="error-log">読み込み中...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">5. 推奨アクション</div>
            <div class="debug-content" id="recommendations">読み込み中...</div>
        </div>
    </div>

    <script>
        // ページ情報の取得
        function getPageInfo() {
            const info = {
                url: window.location.href,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            };
            return JSON.stringify(info, null, 2);
        }

        // CMS 読み込み状況の確認
        function checkCMSStatus() {
            const status = {
                cmsLoaded: typeof CMS !== 'undefined',
                cmsVersion: typeof CMS !== 'undefined' ? CMS.version : 'N/A',
                windowCMS: typeof window.CMS !== 'undefined',
                documentReady: document.readyState
            };
            return JSON.stringify(status, null, 2);
        }

        // 設定ファイルの確認
        async function checkConfig() {
            try {
                const response = await fetch('/admin/config.yml');
                const configText = await response.text();
                return {
                    status: 'success',
                    configExists: true,
                    configContent: configText.substring(0, 500) + '...'
                };
            } catch (error) {
                return {
                    status: 'error',
                    configExists: false,
                    error: error.message
                };
            }
        }

        // エラーログの収集
        function collectErrors() {
            const errors = [];
            
            // 既存のエラーハンドラーを保存
            const originalOnError = window.onerror;
            const originalOnUnhandledRejection = window.onunhandledrejection;

            // エラーハンドラーを設定
            window.onerror = function(message, source, lineno, colno, error) {
                errors.push({
                    type: 'error',
                    message: message,
                    source: source,
                    lineno: lineno,
                    colno: colno,
                    stack: error ? error.stack : 'N/A'
                });
                return false;
            };

            window.onunhandledrejection = function(event) {
                errors.push({
                    type: 'unhandledrejection',
                    reason: event.reason,
                    stack: event.reason ? event.reason.stack : 'N/A'
                });
            };

            return errors;
        }

        // 推奨アクションの生成
        function generateRecommendations(pageInfo, cmsStatus, configStatus, errors) {
            const recommendations = [];

            if (!cmsStatus.cmsLoaded) {
                recommendations.push('❌ CMS が読み込まれていません。Netlify CMS スクリプトを確認してください。');
            } else {
                recommendations.push('✅ CMS が正常に読み込まれています。');
            }

            if (!configStatus.configExists) {
                recommendations.push('❌ 設定ファイルが見つかりません。admin/config.yml を確認してください。');
            } else {
                recommendations.push('✅ 設定ファイルが存在します。');
            }

            if (errors.length > 0) {
                recommendations.push('⚠️ JavaScript エラーが検出されました。コンソールを確認してください。');
            } else {
                recommendations.push('✅ JavaScript エラーは検出されませんでした。');
            }

            recommendations.push('📝 次のステップ:');
            recommendations.push('1. https://kanta02cer.github.io/JAA.HP/admin/ にアクセス');
            recommendations.push('2. 右上の「Login with GitHub」ボタンをクリック');
            recommendations.push('3. GitHub 認証を完了');

            return recommendations.join('\n');
        }

        // メイン処理
        async function runDebug() {
            // ページ情報
            document.getElementById('page-info').textContent = getPageInfo();

            // CMS 状況
            document.getElementById('cms-status').textContent = checkCMSStatus();

            // 設定ファイル確認
            const configStatus = await checkConfig();
            document.getElementById('config-status').textContent = JSON.stringify(configStatus, null, 2);

            // エラーログ
            const errors = collectErrors();
            document.getElementById('error-log').textContent = JSON.stringify(errors, null, 2);

            // 推奨アクション
            const cmsStatus = JSON.parse(document.getElementById('cms-status').textContent);
            const recommendations = generateRecommendations(
                JSON.parse(document.getElementById('page-info').textContent),
                cmsStatus,
                configStatus,
                errors
            );
            document.getElementById('recommendations').textContent = recommendations;
        }

        // ページ読み込み後に実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runDebug);
        } else {
            runDebug();
        }
    </script>
</body>
</html>
