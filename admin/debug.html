<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS Debug - æ—¥æœ¬å­¦ç”Ÿã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼å”ä¼š</title>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .debug-header {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .debug-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .debug-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .debug-content {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .status-success {
            color: #16a34a;
            font-weight: 600;
        }
        .status-error {
            color: #dc2626;
            font-weight: 600;
        }
        .status-warning {
            color: #d97706;
            font-weight: 600;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="debug-container">
        <div class="debug-header">
            <h1>CMS Debug æƒ…å ±</h1>
            <p>Netlify CMS ã®å‹•ä½œçŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™</p>
        </div>

        <div class="debug-section">
            <div class="debug-title">1. ãƒšãƒ¼ã‚¸æƒ…å ±</div>
            <div class="debug-content" id="page-info">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">2. CMS èª­ã¿è¾¼ã¿çŠ¶æ³</div>
            <div class="debug-content" id="cms-status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">3. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª</div>
            <div class="debug-content" id="config-status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">4. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</div>
            <div class="debug-content" id="error-log">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="debug-section">
            <div class="debug-title">5. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
            <div class="debug-content" id="recommendations">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        // ãƒšãƒ¼ã‚¸æƒ…å ±ã®å–å¾—
        function getPageInfo() {
            const info = {
                url: window.location.href,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            };
            return JSON.stringify(info, null, 2);
        }

        // CMS èª­ã¿è¾¼ã¿çŠ¶æ³ã®ç¢ºèª
        function checkCMSStatus() {
            const status = {
                cmsLoaded: typeof CMS !== 'undefined',
                cmsVersion: typeof CMS !== 'undefined' ? CMS.version : 'N/A',
                windowCMS: typeof window.CMS !== 'undefined',
                documentReady: document.readyState
            };
            return JSON.stringify(status, null, 2);
        }

        // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        async function checkConfig() {
            try {
                const response = await fetch('/admin/config.yml');
                const configText = await response.text();
                return {
                    status: 'success',
                    configExists: true,
                    configContent: configText.substring(0, 500) + '...'
                };
            } catch (error) {
                return {
                    status: 'error',
                    configExists: false,
                    error: error.message
                };
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®åé›†
        function collectErrors() {
            const errors = [];
            
            // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä¿å­˜
            const originalOnError = window.onerror;
            const originalOnUnhandledRejection = window.onunhandledrejection;

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
            window.onerror = function(message, source, lineno, colno, error) {
                errors.push({
                    type: 'error',
                    message: message,
                    source: source,
                    lineno: lineno,
                    colno: colno,
                    stack: error ? error.stack : 'N/A'
                });
                return false;
            };

            window.onunhandledrejection = function(event) {
                errors.push({
                    type: 'unhandledrejection',
                    reason: event.reason,
                    stack: event.reason ? event.reason.stack : 'N/A'
                });
            };

            return errors;
        }

        // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ
        function generateRecommendations(pageInfo, cmsStatus, configStatus, errors) {
            const recommendations = [];

            if (!cmsStatus.cmsLoaded) {
                recommendations.push('âŒ CMS ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Netlify CMS ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                recommendations.push('âœ… CMS ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚');
            }

            if (!configStatus.configExists) {
                recommendations.push('âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚admin/config.yml ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                recommendations.push('âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ã€‚');
            }

            if (errors.length > 0) {
                recommendations.push('âš ï¸ JavaScript ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                recommendations.push('âœ… JavaScript ã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
            }

            recommendations.push('ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:');
            recommendations.push('1. https://kanta02cer.github.io/JAA.HP/admin/ ã«ã‚¢ã‚¯ã‚»ã‚¹');
            recommendations.push('2. å³ä¸Šã®ã€ŒLogin with GitHubã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
            recommendations.push('3. GitHub èªè¨¼ã‚’å®Œäº†');

            return recommendations.join('\n');
        }

        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        async function runDebug() {
            // ãƒšãƒ¼ã‚¸æƒ…å ±
            document.getElementById('page-info').textContent = getPageInfo();

            // CMS çŠ¶æ³
            document.getElementById('cms-status').textContent = checkCMSStatus();

            // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
            const configStatus = await checkConfig();
            document.getElementById('config-status').textContent = JSON.stringify(configStatus, null, 2);

            // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
            const errors = collectErrors();
            document.getElementById('error-log').textContent = JSON.stringify(errors, null, 2);

            // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            const cmsStatus = JSON.parse(document.getElementById('cms-status').textContent);
            const recommendations = generateRecommendations(
                JSON.parse(document.getElementById('page-info').textContent),
                cmsStatus,
                configStatus,
                errors
            );
            document.getElementById('recommendations').textContent = recommendations;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runDebug);
        } else {
            runDebug();
        }
    </script>
</body>
</html>
