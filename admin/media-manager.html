<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メディア管理 - JAA CMS</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="../js/toast-notifications.js"></script>
</head>
<body class="bg-gray-50 font-['Inter','Noto_Sans_JP',sans-serif]">
    <!-- ヘッダー -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="cms-dashboard.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>ダッシュボードに戻る
                    </a>
                    <h1 class="text-xl font-bold text-gray-900">メディア管理</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="text-sm text-gray-700"></span>
                    <button id="upload-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-upload mr-2"></i>ファイルアップロード
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- 統計カード -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-images text-3xl text-blue-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">総ファイル数</dt>
                                <dd id="total-files" class="text-lg font-medium text-gray-900">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-image text-3xl text-green-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">画像ファイル</dt>
                                <dd id="image-files" class="text-lg font-medium text-gray-900">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-file text-3xl text-yellow-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">その他ファイル</dt>
                                <dd id="other-files" class="text-lg font-medium text-gray-900">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-hdd text-3xl text-purple-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">使用容量</dt>
                                <dd id="total-size" class="text-lg font-medium text-gray-900">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 検索・フィルター -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex-1 max-w-lg">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="search-input" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="ファイル名で検索...">
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <select id="type-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">全ファイルタイプ</option>
                            <option value="image">画像</option>
                            <option value="document">文書</option>
                            <option value="video">動画</option>
                            <option value="audio">音声</option>
                            <option value="other">その他</option>
                        </select>
                        <select id="sort-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="date-desc">日付（新しい順）</option>
                            <option value="date-asc">日付（古い順）</option>
                            <option value="name-asc">名前（A-Z）</option>
                            <option value="name-desc">名前（Z-A）</option>
                            <option value="size-desc">サイズ（大きい順）</option>
                            <option value="size-asc">サイズ（小さい順）</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ファイル一覧 -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">ファイル一覧</h3>
                    <div class="flex items-center space-x-2">
                        <button id="grid-view-btn" class="p-2 text-gray-400 hover:text-gray-600" title="グリッド表示">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button id="list-view-btn" class="p-2 text-gray-400 hover:text-gray-600" title="リスト表示">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <!-- グリッド表示 -->
                <div id="grid-view" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <!-- ファイルがここに動的に挿入されます -->
                </div>
                
                <!-- リスト表示 -->
                <div id="list-view" class="hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ファイル</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイプ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">サイズ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">アップロード日</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="list-view-body" class="bg-white divide-y divide-gray-200">
                            <!-- ファイルがここに動的に挿入されます -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- アップロードモーダル -->
    <div id="upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">ファイルアップロード</h3>
                    <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ファイルを選択</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                            <input type="file" id="file-input" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" class="hidden">
                            <div id="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">クリックしてファイルを選択</p>
                                <p class="text-sm text-gray-500 mt-2">または、ファイルをここにドラッグ&ドロップ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="upload-progress" class="hidden">
                        <div class="space-y-2">
                            <div id="upload-status" class="text-sm text-gray-600"></div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="uploaded-files" class="space-y-2">
                        <!-- アップロードされたファイルがここに表示されます -->
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeUploadModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-400">
                        キャンセル
                    </button>
                    <button id="start-upload-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        アップロード開始
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ファイル詳細モーダル -->
    <div id="file-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="detail-modal-title" class="text-lg font-medium text-gray-900">ファイル詳細</h3>
                    <button onclick="closeFileDetailModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="detail-modal-content">
                    <!-- ファイル詳細がここに表示されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">処理中...</span>
            </div>
        </div>
    </div>



    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyDUm0XzV9wPIHJSTsKiJ9LXqjlIA81l1Rc",
            authDomain: "jaa-hp.firebaseapp.com",
            projectId: "jaa-hp",
            storageBucket: "jaa-hp.appspot.com",
            messagingSenderId: "549447513177",
            appId: "1:549447513177:web:2f2fc2f9bfe0ddd29d6d48",
            measurementId: "G-JLRH848YQS"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // グローバル変数
        let currentUser = null;
        let mediaFiles = [];
        let selectedFiles = [];
        let currentView = 'grid';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            setupEventListeners();
            setupDragAndDrop();
        });

        // 認証初期化
        function initializeAuth() {
            auth.onAuthStateChanged(function(user) {
                if (user && user.emailVerified) {
                    currentUser = user;
                    document.getElementById('user-info').textContent = `${user.email} (認証済み)`;
                    loadMediaFiles();
                } else {
                    window.location.href = 'news-console.html';
                }
            });
        }

        // イベントリスナー設定
        function setupEventListeners() {
            document.getElementById('upload-btn').addEventListener('click', openUploadModal);
            document.getElementById('search-input').addEventListener('input', filterFiles);
            document.getElementById('type-filter').addEventListener('change', filterFiles);
            document.getElementById('sort-filter').addEventListener('change', sortFiles);
            document.getElementById('grid-view-btn').addEventListener('click', () => switchView('grid'));
            document.getElementById('list-view-btn').addEventListener('click', () => switchView('list'));
            document.getElementById('start-upload-btn').addEventListener('click', startUpload);
            
            // ファイル選択
            document.getElementById('file-input').addEventListener('change', handleFileSelection);
        }

        // ドラッグ&ドロップ設定
        function setupDragAndDrop() {
            const uploadArea = document.querySelector('#upload-modal .border-dashed');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }

        // メディアファイル読み込み
        async function loadMediaFiles() {
            showLoading();
            try {
                // Firestoreからメディア情報を読み込み
                const mediaRef = db.collection('media');
                const snapshot = await mediaRef.orderBy('uploadedAt', 'desc').get();
                
                mediaFiles = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateStatistics();
                renderFiles();
            } catch (error) {
                console.error('メディアファイル読み込みエラー:', error);
                showError('メディアファイルの読み込みに失敗しました');
            } finally {
                hideLoading();
            }
        }

        // 統計更新
        function updateStatistics() {
            const totalFiles = mediaFiles.length;
            const imageFiles = mediaFiles.filter(file => file.type === 'image').length;
            const otherFiles = totalFiles - imageFiles;
            const totalSize = mediaFiles.reduce((sum, file) => sum + (file.size || 0), 0);

            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('image-files').textContent = imageFiles;
            document.getElementById('other-files').textContent = otherFiles;
            document.getElementById('total-size').textContent = formatFileSize(totalSize);
        }

        // ファイル表示
        function renderFiles() {
            renderGridView();
            renderListView();
        }

        // グリッド表示
        function renderGridView() {
            const container = document.getElementById('grid-view');
            container.innerHTML = '';

            mediaFiles.forEach(file => {
                const fileElement = createFileGridElement(file);
                container.appendChild(fileElement);
            });
        }

        // リスト表示
        function renderListView() {
            const tbody = document.getElementById('list-view-body');
            tbody.innerHTML = '';

            mediaFiles.forEach(file => {
                const row = createFileListRow(file);
                tbody.appendChild(row);
            });
        }

        // グリッド要素作成
        function createFileGridElement(file) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow cursor-pointer';
            
            const isImage = file.type === 'image';
            const thumbnail = isImage ? file.url : getFileIcon(file.type);
            
            div.innerHTML = `
                <div class="aspect-square bg-gray-100 flex items-center justify-center overflow-hidden">
                    ${isImage ? 
                        `<img src="${thumbnail}" alt="${file.name}" class="w-full h-full object-cover">` :
                        `<div class="text-4xl text-gray-400">${thumbnail}</div>`
                    }
                </div>
                <div class="p-3">
                    <div class="text-sm font-medium text-gray-900 truncate" title="${file.name}">${file.name}</div>
                    <div class="text-xs text-gray-500">${formatFileSize(file.size)}</div>
                    <div class="text-xs text-gray-400">${formatDate(file.uploadedAt)}</div>
                </div>
            `;
            
            div.addEventListener('click', () => showFileDetail(file));
            return div;
        }

        // リスト行作成
        function createFileListRow(file) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const isImage = file.type === 'image';
            const thumbnail = isImage ? file.url : getFileIcon(file.type);
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            ${isImage ? 
                                `<img src="${thumbnail}" alt="${file.name}" class="h-10 w-10 rounded object-cover">` :
                                `<div class="h-10 w-10 bg-gray-100 rounded flex items-center justify-center text-gray-400">${thumbnail}</div>`
                            }
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${file.name}</div>
                            <div class="text-sm text-gray-500">${file.type}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getTypeColor(file.type)}">
                        ${getTypeText(file.type)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatFileSize(file.size)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(file.uploadedAt)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="showFileDetail('${file.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                        詳細
                    </button>
                    <button onclick="deleteFile('${file.id}')" class="text-red-600 hover:text-red-900">
                        削除
                    </button>
                </td>
            `;
            
            return row;
        }

        // ファイルタイプ色取得
        function getTypeColor(type) {
            const colors = {
                'image': 'bg-green-100 text-green-800',
                'document': 'bg-blue-100 text-blue-800',
                'video': 'bg-purple-100 text-purple-800',
                'audio': 'bg-yellow-100 text-yellow-800',
                'other': 'bg-gray-100 text-gray-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        // ファイルタイプテキスト取得
        function getTypeText(type) {
            const texts = {
                'image': '画像',
                'document': '文書',
                'video': '動画',
                'audio': '音声',
                'other': 'その他'
            };
            return texts[type] || '不明';
        }

        // ファイルアイコン取得
        function getFileIcon(type) {
            const icons = {
                'image': '🖼️',
                'document': '📄',
                'video': '🎥',
                'audio': '🎵',
                'other': '📁'
            };
            return icons[type] || '📁';
        }

        // ファイルフィルタリング
        function filterFiles() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;

            const filtered = mediaFiles.filter(file => {
                const searchMatch = !searchQuery || file.name.toLowerCase().includes(searchQuery);
                const typeMatch = !typeFilter || file.type === typeFilter;
                return searchMatch && typeMatch;
            });

            renderFilteredFiles(filtered);
        }

        // フィルタリングされたファイルを表示
        function renderFilteredFiles(filteredFiles) {
            // グリッド表示
            const gridContainer = document.getElementById('grid-view');
            gridContainer.innerHTML = '';
            
            filteredFiles.forEach(file => {
                const fileElement = createFileGridElement(file);
                gridContainer.appendChild(fileElement);
            });

            // リスト表示
            const listBody = document.getElementById('list-view-body');
            listBody.innerHTML = '';
            
            filteredFiles.forEach(file => {
                const row = createFileListRow(file);
                listBody.appendChild(row);
            });
        }

        // ファイルソート
        function sortFiles() {
            const sortBy = document.getElementById('sort-filter').value;
            
            const sorted = [...mediaFiles].sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.uploadedAt) - new Date(a.uploadedAt);
                    case 'date-asc':
                        return new Date(a.uploadedAt) - new Date(b.uploadedAt);
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'size-desc':
                        return (b.size || 0) - (a.size || 0);
                    case 'size-asc':
                        return (a.size || 0) - (b.size || 0);
                    default:
                        return 0;
                }
            });

            mediaFiles = sorted;
            renderFiles();
        }

        // ビュー切り替え
        function switchView(view) {
            currentView = view;
            
            if (view === 'grid') {
                document.getElementById('grid-view').classList.remove('hidden');
                document.getElementById('list-view').classList.add('hidden');
                document.getElementById('grid-view-btn').classList.add('text-blue-600');
                document.getElementById('list-view-btn').classList.remove('text-blue-600');
            } else {
                document.getElementById('grid-view').classList.add('hidden');
                document.getElementById('list-view').classList.remove('hidden');
                document.getElementById('grid-view-btn').classList.remove('text-blue-600');
                document.getElementById('list-view-btn').classList.add('text-blue-600');
            }
        }

        // アップロードモーダルを開く
        function openUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
            selectedFiles = [];
            document.getElementById('uploaded-files').innerHTML = '';
            document.getElementById('upload-progress').classList.add('hidden');
        }

        // アップロードモーダルを閉じる
        function closeUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }

        // ファイル選択処理
        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        // ファイル処理
        function handleFiles(files) {
            selectedFiles = files;
            const container = document.getElementById('uploaded-files');
            container.innerHTML = '';

            files.forEach((file, index) => {
                const fileElement = createUploadFileElement(file, index);
                container.appendChild(fileElement);
            });
        }

        // アップロードファイル要素作成
        function createUploadFileElement(file, index) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-gray-400">
                        ${getFileIcon(getFileType(file.name))}
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${file.name}</div>
                        <div class="text-xs text-gray-500">${formatFileSize(file.size)}</div>
                    </div>
                </div>
                <button onclick="removeSelectedFile(${index})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            return div;
        }

        // 選択されたファイルを削除
        function removeSelectedFile(index) {
            selectedFiles.splice(index, 1);
            document.getElementById('file-input').value = '';
            handleFiles(selectedFiles);
        }

        // アップロード開始
        async function startUpload() {
            if (selectedFiles.length === 0) {
                showError('ファイルを選択してください');
                return;
            }

            document.getElementById('upload-progress').classList.remove('hidden');
            document.getElementById('start-upload-btn').disabled = true;

            let uploadedCount = 0;
            const totalFiles = selectedFiles.length;

            for (const file of selectedFiles) {
                try {
                    await uploadFile(file);
                    uploadedCount++;
                    
                    const progress = (uploadedCount / totalFiles) * 100;
                    document.getElementById('progress-bar').style.width = `${progress}%`;
                    document.getElementById('upload-status').textContent = `${uploadedCount}/${totalFiles} ファイルをアップロード中...`;
                    
                } catch (error) {
                    console.error('ファイルアップロードエラー:', error);
                    showError(`${file.name} のアップロードに失敗しました`);
                }
            }

            showSuccess(`${uploadedCount} ファイルのアップロードが完了しました`);
            document.getElementById('upload-progress').classList.add('hidden');
            document.getElementById('start-upload-btn').disabled = false;
            
            // ファイル一覧を更新
            await loadMediaFiles();
            
            // モーダルを閉じる
            setTimeout(() => {
                closeUploadModal();
            }, 2000);
        }

        // 個別ファイルアップロード
        async function uploadFile(file) {
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`media/${Date.now()}_${file.name}`);
            
            const snapshot = await fileRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            
            // Firestoreにメタデータを保存
            const fileData = {
                name: file.name,
                type: getFileType(file.name),
                size: file.size,
                url: downloadURL,
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                uploadedBy: currentUser.email,
                contentType: file.type
            };
            
            await db.collection('media').add(fileData);
        }

        // ファイルタイプ判定
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];
            const documentExts = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];
            const videoExts = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'];
            const audioExts = ['mp3', 'wav', 'ogg', 'aac', 'flac'];
            
            if (imageExts.includes(ext)) return 'image';
            if (documentExts.includes(ext)) return 'document';
            if (videoExts.includes(ext)) return 'video';
            if (audioExts.includes(ext)) return 'audio';
            return 'other';
        }

        // ファイル詳細表示
        function showFileDetail(file) {
            if (typeof file === 'string') {
                file = mediaFiles.find(f => f.id === file);
            }
            
            if (!file) return;
            
            const modal = document.getElementById('file-detail-modal');
            const title = document.getElementById('detail-modal-title');
            const content = document.getElementById('detail-modal-content');
            
            title.textContent = file.name;
            
            const isImage = file.type === 'image';
            const preview = isImage ? 
                `<img src="${file.url}" alt="${file.name}" class="max-w-full h-auto rounded-lg shadow-lg mb-4">` :
                `<div class="text-6xl text-gray-400 text-center mb-4">${getFileIcon(file.type)}</div>`;
            
            content.innerHTML = `
                <div class="space-y-4">
                    ${preview}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ファイル名</label>
                            <p class="text-sm text-gray-900">${file.name}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ファイルタイプ</label>
                            <p class="text-sm text-gray-900">${getTypeText(file.type)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ファイルサイズ</label>
                            <p class="text-sm text-gray-900">${formatFileSize(file.size)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">アップロード日</label>
                            <p class="text-sm text-gray-900">${formatDate(file.uploadedAt)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">アップロード者</label>
                            <p class="text-sm text-gray-900">${file.uploadedBy || '不明'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">URL</label>
                            <p class="text-sm text-gray-900 break-all">${file.url}</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button onclick="copyFileUrl('${file.url}')" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-copy mr-2"></i>URLをコピー
                        </button>
                        <button onclick="downloadFile('${file.url}', '${file.name}')" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>ダウンロード
                        </button>
                        <button onclick="deleteFile('${file.id}')" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>削除
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // ファイル詳細モーダルを閉じる
        function closeFileDetailModal() {
            document.getElementById('file-detail-modal').classList.add('hidden');
        }

        // ファイル削除
        async function deleteFile(fileId) {
            if (!confirm('このファイルを削除してもよろしいですか？この操作は取り消せません。')) {
                return;
            }

            showLoading();
            try {
                const file = mediaFiles.find(f => f.id === fileId);
                if (file) {
                    // Storageからファイルを削除
                    const storageRef = storage.refFromURL(file.url);
                    await storageRef.delete();
                    
                    // Firestoreからメタデータを削除
                    await db.collection('media').doc(fileId).delete();
                    
                    showSuccess('ファイルが削除されました');
                    await loadMediaFiles();
                }
            } catch (error) {
                console.error('ファイル削除エラー:', error);
                showError('ファイルの削除に失敗しました');
            } finally {
                hideLoading();
            }
        }

        // URLコピー
        function copyFileUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('URLがクリップボードにコピーされました');
            }).catch(() => {
                showError('URLのコピーに失敗しました');
            });
        }

        // ファイルダウンロード
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ユーティリティ関数
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            if (!timestamp) return '不明';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ja-JP');
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showSuccess(message) {
            toastNotifications.success(message);
        }

        function showError(message) {
            toastNotifications.error(message);
        }

        function showWarning(message) {
            toastNotifications.warning(message);
        }

        function showInfo(message) {
            toastNotifications.info(message);
        }
    </script>
</body>
</html>
