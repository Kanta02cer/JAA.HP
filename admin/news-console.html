<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ニュース管理コンソール</title>
  <link rel="icon" href="https://i.ibb.co/6R5nX1YH/Rogo.jpg" />
      <script src="https://cdn.tailwindcss.com"></script>
    <script src="../js/unified-article-manager.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    // React
    import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18';
    import { createRoot } from 'https://esm.sh/react-dom@18/client';

    // Firebase (v9 ESM)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      onAuthStateChanged, updateProfile, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyDUm0XzV9wPIHJSTsKiJ9LXqjlIA81l1Rc",
      authDomain: "jaa-hp.firebaseapp.com",
      projectId: "jaa-hp",
      storageBucket: "jaa-hp.appspot.com",
      messagingSenderId: "549447513177",
      appId: "1:549447513177:web:2f2fc2f9bfe0ddd29d6d48",
      measurementId: "G-JLRH848YQS"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const SECRET_INVITE_CODE = "JAA-NEWS-ADMIN";

    // 統合記事管理システムとの同期
    async function syncToUnifiedArticleManager(articleId, data, action) {
      try {
        // 記事データの構造を統一
        const articleData = {
          id: articleId,
          title: data.title || '無題の記事',
          content: data.content || '',
          category: data.category || 'お知らせ',
          status: data.status || 'draft',
          createdAt: data.createdAt ? data.createdAt.toDate().toISOString() : new Date().toISOString(),
          updatedAt: data.updatedAt ? data.updatedAt.toDate().toISOString() : new Date().toISOString(),
          source: 'news-console',
          lastSynced: Date.now()
        };

        // 統合記事管理システムが利用可能かチェック
        if (typeof window.unifiedArticleManager !== 'undefined') {
          await window.unifiedArticleManager.saveArticle(articleData, 'news-console');
          console.log(`統合記事管理システムに同期完了: ${action} - ${articleId}`);
        } else {
          console.log('統合記事管理システムが利用できません。ローカルストレージに保存します。');
        }

        // 常にローカルストレージにも保存（バックアップ）
        await saveToLocalStorage(articleId, articleData, action);
        
        // 強制的な同期処理を実行
        await forceSyncToNewsDetail(articleId, articleData);
        
      } catch (error) {
        console.error('統合記事管理システム同期エラー:', error);
        // エラーの場合はローカルストレージに保存
        await saveToLocalStorage(articleId, data, action);
      }
    }

    // news-detail.htmlへの強制同期
    async function forceSyncToNewsDetail(articleId, articleData) {
      try {
        // 1. カスタムイベントの発火
        window.dispatchEvent(new CustomEvent('jaa-news-update', {
          detail: {
            action: 'save',
            articleId: articleId,
            article: articleData,
            timestamp: Date.now(),
            type: 'NEWS_UPDATE'
          }
        }));

        // 2. localStorageの強制更新
        const storageKey = 'jaa-unified-articles';
        const existingArticles = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const existingIndex = existingArticles.findIndex(a => a.id === articleId);
        
        if (existingIndex >= 0) {
          existingArticles[existingIndex] = { ...existingArticles[existingIndex], ...articleData };
        } else {
          existingArticles.unshift(articleData);
        }
        
        // 記事を日付順でソート
        existingArticles.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
        });
        
        localStorage.setItem(storageKey, JSON.stringify(existingArticles));

        // 3. 強制更新トリガーの発火
        const triggerKey = `jaa-news-update-${Date.now()}`;
        localStorage.setItem(triggerKey, JSON.stringify({
          action: 'save',
          articleId: articleId,
          article: articleData,
          timestamp: Date.now(),
          type: 'NEWS_UPDATE'
        }));
        localStorage.removeItem(triggerKey);

        console.log(`news-detail.html強制同期完了: ${articleId}`);
      } catch (error) {
        console.error('news-detail.html強制同期エラー:', error);
      }
    }

    // ローカルストレージへの保存（フォールバック）
    async function saveToLocalStorage(articleId, data, action) {
      try {
        const storageKey = 'jaa-unified-articles';
        const existingArticles = JSON.parse(localStorage.getItem(storageKey) || '[]');
        
        // 既存記事の更新または新規追加
        const existingIndex = existingArticles.findIndex(a => a.id === articleId);
        if (existingIndex >= 0) {
          existingArticles[existingIndex] = { ...existingArticles[existingIndex], ...data };
        } else {
          existingArticles.unshift(data);
        }
        
        // 記事を日付順でソート
        existingArticles.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
        });
        
        // ローカルストレージに保存
        localStorage.setItem(storageKey, JSON.stringify(existingArticles));
        
        console.log(`ローカルストレージに保存完了: ${action} - ${articleId}`);
        
      } catch (error) {
        console.error('ローカルストレージ保存エラー:', error);
      }
    }



    // ニュース更新通知システム
    async function notifyNewsUpdate(action, articleId, article) {
      try {
        // 1. ページ間通信での通知
        await broadcastToOtherPages(action, articleId, article);
        
        // 2. 他のページのキャッシュを無効化
        await invalidateNewsCache();
        
        // 3. リアルタイム更新を強制実行
        await forceNewsRefresh();
        
        // 4. 成功メッセージ
        console.log(`ニュース更新通知完了: ${action} - ${articleId}`);
        
        // 5. 管理者向けの詳細通知
        showUpdateNotification(action, article);
        
      } catch (error) {
        console.error('ニュース更新通知エラー:', error);
        // エラーが発生しても記事の保存は完了しているので、警告のみ表示
        alert(`記事は保存されましたが、他のページへの反映に時間がかかる場合があります。`);
      }
    }
    
    // ページ間通信での通知
    async function broadcastToOtherPages(action, articleId, article) {
      try {
        // BroadcastChannel APIを使用
        if (typeof BroadcastChannel !== 'undefined') {
          const channel = new BroadcastChannel('jaa-news-update');
          channel.postMessage({
            type: 'NEWS_UPDATE',
            action: action,
            articleId: articleId,
            article: article,
            timestamp: Date.now(),
            source: window.location.href
          });
          channel.close();
        }
        
        // localStorageイベントを使用（フォールバック）
        const eventData = {
          action: action,
          articleId: articleId,
          article: article,
          timestamp: Date.now(),
          type: 'NEWS_UPDATE'
        };
        
        // カスタムイベントを発火
        window.dispatchEvent(new CustomEvent('jaa-news-update', { detail: eventData }));
        
        // localStorageの変更をトリガー
        const triggerKey = `jaa-news-update-${Date.now()}`;
        localStorage.setItem(triggerKey, JSON.stringify(eventData));
        localStorage.removeItem(triggerKey);
        
        console.log('ページ間通信通知完了');
        
      } catch (error) {
        console.error('ページ間通信エラー:', error);
      }
    }
    
    // サンプル記事の作成
    async function createSampleArticles() {
      if (!confirm('サンプル記事を作成しますか？これにより、システムの動作確認ができます。')) {
        return;
      }
      
      const sampleArticles = [
        {
          title: '日本学生アンバサダー協会 設立のお知らせ',
          content: `
            <h2>日本学生アンバサダー協会 設立のお知らせ</h2>
            <p>平素より学生支援活動にご理解とご支援を賜り、誠にありがとうございます。</p>
            
            <p>この度、学生の可能性を最大限に引き出し、社会との架け橋となることを目指して「日本学生アンバサダー協会」を設立いたしました。</p>
            
            <h3>設立の背景</h3>
            <p>現代の学生は、多くの可能性を秘めながらも、適切な機会やサポートが不足している状況にあります。私たちは、この課題を解決し、学生一人ひとりが自信を持って社会に羽ばたける環境づくりを目指します。</p>
            
            <h3>主な活動内容</h3>
            <ul>
              <li>学生アンバサダー認定プログラムの運営</li>
              <li>企業との連携によるインターンシップ機会の創出</li>
              <li>学生向けキャリア支援・就職支援</li>
              <li>学生団体・プロジェクトの支援</li>
            </ul>
            
            <h3>今後の展望</h3>
            <p>今後は、全国の学生にサービスを提供し、学生と企業・社会をつなぐプラットフォームとして発展させてまいります。</p>
            
            <p>引き続き、ご支援とご協力を賜りますよう、心よりお願い申し上げます。</p>
          `,
          category: 'お知らせ',
          status: 'published'
        },
        {
          title: '第1回学生アンバサダー認定プログラム開始',
          content: `
            <h2>第1回学生アンバサダー認定プログラム開始</h2>
            <p>日本学生アンバサダー協会では、学生のリーダーシップと社会貢献活動を支援する「学生アンバサダー認定プログラム」を開始いたします。</p>
            
            <h3>プログラム概要</h3>
            <p>このプログラムは、学生が自らの能力を高め、社会に貢献する活動を行うことで、認定証を取得できる制度です。</p>
            
            <h3>認定条件</h3>
            <ul>
              <li>リーダーシップを発揮した活動実績</li>
              <li>社会貢献活動への積極的な参加</li>
              <li>継続的な学習と成長への意欲</li>
              <li>他者への影響力と信頼性</li>
            </ul>
            
            <h3>プログラムの流れ</h3>
            <ol>
              <li>エントリー（オンライン申請）</li>
              <li>書類審査</li>
              <li>面接審査</li>
              <li>認定証授与式</li>
            </ol>
            
            <h3>応募期間</h3>
            <p>2025年2月1日〜2025年3月31日</p>
            
            <p>多くの学生の皆様のご応募をお待ちしております。</p>
          `,
          category: 'イベント',
          status: 'published'
        },
        {
          title: '企業パートナーシッププログラムの開始',
          content: `
            <h2>企業パートナーシッププログラムの開始</h2>
            <p>日本学生アンバサダー協会では、学生と企業をつなぐ「企業パートナーシッププログラム」を開始いたします。</p>
            
            <h3>プログラムの目的</h3>
            <p>優秀な学生と企業をマッチングし、双方にとって価値のある関係を構築することを目指しています。</p>
            
            <h3>企業向けサービス</h3>
            <ul>
              <li>優秀な学生の紹介・推薦</li>
              <li>インターンシッププログラムの企画・運営支援</li>
              <li>学生向け企業説明会の開催支援</li>
              <li>学生の能力開発プログラムの提供</li>
            </ul>
            
            <h3>学生向けサービス</h3>
            <ul>
              <li>企業インターンシップの紹介</li>
              <li>就職活動支援・キャリア相談</li>
              <li>企業訪問・見学会の開催</li>
              <li>スキルアップセミナーの提供</li>
            </ul>
            
            <h3>参加企業</h3>
            <p>現在、複数の企業様とパートナーシップを結んでおり、今後も拡大予定です。</p>
            
            <p>企業の皆様、学生の皆様、ぜひご参加ください。</p>
          `,
          category: 'パートナーシップ',
          status: 'published'
        }
      ];
      
      try {
        for (const articleData of sampleArticles) {
          const docRef = await addDoc(collection(db, 'news'), {
            ...articleData,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          
          // 統合記事管理システムとの同期
          await syncToUnifiedArticleManager(docRef.id, articleData, 'create');
          
          // ニュース更新通知
          await notifyNewsUpdate('create', docRef.id, { ...articleData, id: docRef.id });
        }
        
        alert('サンプル記事の作成が完了しました！他のページにも即座に反映されます。');
        fetchArticles();
        
      } catch (error) {
        console.error('サンプル記事作成エラー:', error);
        alert('サンプル記事の作成に失敗しました。');
      }
    }

    // ニュースキャッシュの無効化
    async function invalidateNewsCache() {
      try {
        // ローカルストレージのキャッシュをクリア
        if (typeof localStorage !== 'undefined') {
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.includes('news') || key.includes('cache')) {
              localStorage.removeItem(key);
            }
          });
        }
        console.log('ローカルキャッシュ無効化完了');
      } catch (error) {
        console.log('キャッシュ無効化エラー:', error);
      }
    }

    // ニュースの強制更新
    async function forceNewsRefresh() {
      try {
        // 他のページに通知を送信
        if (typeof window !== 'undefined') {
          // 同じドメイン内の他のページに通知
          window.postMessage({
            type: 'FORCE_NEWS_REFRESH',
            timestamp: Date.now(),
            action: 'refresh'
          }, '*');

          // 親ページがある場合（iframe内の場合）
          if (window.parent !== window) {
            window.parent.postMessage({
              type: 'FORCE_NEWS_REFRESH',
              timestamp: Date.now(),
              action: 'refresh'
            }, '*');
          }
        }

        // Service Workerに通知（利用可能な場合）
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'NEWS_UPDATED',
            action: 'refresh',
            timestamp: Date.now()
          });
        }

        // 統合記事管理システムの強制更新
        if (typeof window.unifiedArticleManager !== 'undefined') {
          window.unifiedArticleManager.forceRefresh();
        }

        console.log('ニュース強制更新通知完了');
      } catch (error) {
        console.log('強制更新通知エラー:', error);
      }
    }

    // 更新通知の表示
    function showUpdateNotification(action, article) {
      // 既存の通知があれば削除
      const existingNotification = document.querySelector('.news-update-notification');
      if (existingNotification) {
        existingNotification.remove();
      }

      // 新しい通知を作成
      const notification = document.createElement('div');
      notification.className = 'news-update-notification fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
      notification.innerHTML = `
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <div>
            <p class="font-bold">記事${action}完了！</p>
            <p class="text-sm opacity-90">${article.title}</p>
            <p class="text-xs opacity-75">他のページに自動反映されます</p>
          </div>
        </div>
      `;

      document.body.appendChild(notification);

      // 5秒後に自動で消える
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // --- 日本語入力最適化されたRichTextEditor ---
    const RichTextEditor = ({ value, onChange }) => {
      const editorRef = useRef(null);
      const [showPreview, setShowPreview] = useState(false);
      const [previewContent, setPreviewContent] = useState('');
      const [isComposing, setIsComposing] = useState(false);
      const [lastValue, setLastValue] = useState('');

      // 日本語入力中の状態管理
      const handleCompositionStart = () => {
        setIsComposing(true);
      };

      const handleCompositionEnd = () => {
        setIsComposing(false);
        // IME入力完了後に内容を更新
        setTimeout(() => {
          if (editorRef.current) {
            const currentContent = editorRef.current.innerHTML;
            if (currentContent !== lastValue) {
              setLastValue(currentContent);
              onChange(currentContent);
              setPreviewContent(currentContent);
            }
          }
        }, 10);
      };

      // 改良されたフォーマット処理
      const handleFormat = (type) => {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;

        const range = selection.getRangeAt(0);
        if (!range || range.collapsed) return;

        const selectedText = range.toString();
        if (!selectedText) return;

        let newContent = '';
        switch (type) {
          case 'h2':
            newContent = `<h2>${selectedText}</h2>`;
            break;
          case 'bold':
            newContent = `<strong>${selectedText}</strong>`;
            break;
          case 'underline':
            newContent = `<u>${selectedText}</u>`;
            break;
          case 'ul':
            newContent = `<ul><li>${selectedText}</li></ul>`;
            break;
          case 'ol':
            newContent = `<ol><li>${selectedText}</li></ol>`;
            break;
          default:
            return;
        }

        // 選択範囲を新しいコンテンツで置換
        range.deleteContents();
        const div = document.createElement('div');
        div.innerHTML = newContent;
        const fragment = document.createDocumentFragment();
        while (div.firstChild) {
          fragment.appendChild(div.firstChild);
        }
        range.insertNode(fragment);
        
        // エディターにフォーカスを戻す
        editorRef.current?.focus();
        
        // 変更を通知
        const updatedContent = editorRef.current.innerHTML;
        setLastValue(updatedContent);
        onChange(updatedContent);
        setPreviewContent(updatedContent);
      };

      // 最適化された入力処理
      const handleInput = (e) => {
        if (isComposing) return; // IME入力中は処理しない
        
        const currentContent = e.target.innerHTML;
        if (currentContent !== lastValue) {
          setLastValue(currentContent);
          onChange(currentContent);
          setPreviewContent(currentContent);
        }
      };

      // キーダウン処理（日本語入力の改善）
      const handleKeyDown = (e) => {
        // Enterキーで改行
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.execCommand('insertLineBreak', false, null);
          handleInput(e);
        }
        // 日本語入力中の特殊キー処理
        if (isComposing) {
          if (e.key === 'Escape') {
            e.preventDefault();
            // IME入力をキャンセル
            editorRef.current?.blur();
            editorRef.current?.focus();
          }
        }
      };

      // フォーカス処理（日本語入力の安定性向上）
      const handleFocus = () => {
        // フォーカス時にカーソルを末尾に移動
        if (editorRef.current) {
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(editorRef.current);
          range.collapse(false);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      };

      // ペースト処理（日本語入力の改善）
      const handlePaste = (e) => {
        e.preventDefault();
        const text = e.clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
        handleInput(e);
      };

      const togglePreview = () => {
        if (!showPreview) {
          setPreviewContent(editorRef.current.innerHTML);
        }
        setShowPreview(!showPreview);
      };

      // 初期値の設定
      useEffect(() => {
        if (value && value !== lastValue) {
          setLastValue(value);
          setPreviewContent(value);
        }
      }, [value]);

      return (
        React.createElement('div', { className: 'border border-gray-300 rounded-md' },
          React.createElement('div', { className: 'flex items-center p-2 border-b bg-gray-50 space-x-2' },
            React.createElement('button', { 
              type: 'button', 
              onClick: () => handleFormat('h2'), 
              className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' 
            }, 'H2'),
            React.createElement('button', { 
              type: 'button', 
              onClick: () => handleFormat('bold'), 
              className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' 
            }, '太字'),
            React.createElement('button', { 
              type: 'button', 
              onClick: () => handleFormat('underline'), 
              className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' 
            }, '下線'),
            React.createElement('button', { 
              type: 'button', 
              onClick: () => handleFormat('ul'), 
              className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' 
            }, '・箇条書き'),
            React.createElement('button', { 
              type: 'button', 
              onClick: () => handleFormat('ol'), 
              className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' 
            }, '1. 数字リスト'),
            React.createElement('button', { 
              type: 'button', 
              onClick: togglePreview, 
              className: `px-3 py-1 border border-gray-300 rounded-md text-sm font-medium ${showPreview ? 'bg-blue-500 text-white' : 'bg-white hover:bg-gray-100'}` 
            }, showPreview ? '編集に戻る' : 'プレビュー')
          ),
          showPreview 
            ? React.createElement('div', { 
                className: 'w-full h-64 p-3 bg-gray-50 overflow-y-auto border-l-4 border-blue-500',
                dangerouslySetInnerHTML: { __html: previewContent || value || '' }
              })
            : React.createElement('div', {
                ref: editorRef,
                className: 'w-full h-64 p-3 focus:outline-none overflow-y-auto',
                contentEditable: true,
                onInput: handleInput,
                onKeyDown: handleKeyDown,
                onFocus: handleFocus,
                onPaste: handlePaste,
                onCompositionStart: handleCompositionStart,
                onCompositionEnd: handleCompositionEnd,
                dangerouslySetInnerHTML: { __html: value || '' },
                style: { 
                  fontFamily: 'Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif',
                  fontSize: '16px',
                  lineHeight: '1.6',
                  wordBreak: 'break-word',
                  whiteSpace: 'pre-wrap',
                  caretColor: '#000000'
                }
              })
        )
      );
    };

    const LoadingScreen = () => (
      React.createElement('div', { className: 'flex items-center justify-center min-h-screen bg-gray-50' },
        React.createElement('div', { className: 'flex flex-col items-center' },
          React.createElement('div', { className: 'animate-spin rounded-full h-16 w-16 border-b-4 border-orange-500' }),
          React.createElement('p', { className: 'mt-4 text-lg text-gray-600' }, '読み込み中...')
        )
      )
    );

    // メール認証画面（提示コード準拠）
    const EmailVerificationScreen = ({ user }) => {
      const [resendDisabled, setResendDisabled] = useState(false);
      const [countdown, setCountdown] = useState(15 * 60);
      const [message, setMessage] = useState('');
      const timerRef = useRef(null);

      useEffect(() => {
        timerRef.current = setInterval(() => {
          setCountdown(prev => {
            if (prev <= 1) {
              clearInterval(timerRef.current);
              return 0;
            }
            return prev - 1;
          });
        }, 1000);
        return () => clearInterval(timerRef.current);
      }, []);

      const handleResendEmail = async () => {
        setResendDisabled(true);
        setMessage('');
        try {
          await sendEmailVerification(user);
          setMessage('確認メールを再送信しました。');
        } catch (error) {
          setMessage('メールの送信に失敗しました。時間をおいて再度お試しください。');
          console.error(error);
        }
        setTimeout(() => setResendDisabled(false), 60000);
      };

      const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
      };

      return (
        React.createElement('div', { className: 'flex items-center justify-center min-h-screen bg-gray-100' },
          React.createElement('div', { className: 'w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg text-center' },
            React.createElement('h2', { className: 'text-2xl font-bold text-gray-800' }, 'メールアドレスの確認'),
            React.createElement('p', { className: 'text-gray-600' },
              React.createElement('strong', { className: 'text-orange-600' }, user.email),
              ' 宛に確認メールを送信しました。メール内のリンクをクリックして、アカウント登録を完了してください。'
            ),
            countdown > 0
              ? React.createElement('p', { className: 'text-lg font-bold text-gray-700' }, 'リンクの有効期限: ', React.createElement('span', { className: 'text-red-500' }, formatTime(countdown)))
              : React.createElement('p', { className: 'text-red-500 font-bold' }, '認証リンクの有効期限が切れました。再送してください。'),
            React.createElement('button', { onClick: handleResendEmail, disabled: resendDisabled, className: 'w-full py-3 font-bold text-white bg-orange-500 rounded-md hover:bg-orange-600 transition-colors duration-300 disabled:bg-gray-400' }, resendDisabled ? '60秒後に再送可能' : '確認メールを再送する'),
            message && React.createElement('p', { className: 'text-green-600 text-sm' }, message),
             React.createElement('p', { className: 'text-sm text-gray-500' }, 'メールが見当たらない場合は、迷惑メールフォルダをご確認ください。迷惑メールに分類されている場合は「迷惑メールではない」としてマークしてください。'),
            React.createElement('p', { className: 'text-sm text-gray-500 pt-4' }, '認証が完了したら、ページをリロードしてください。'),
            React.createElement('button', { onClick: () => signOut(auth), className: 'mt-2 text-sm text-gray-500 hover:underline' }, 'ログアウト')
          )
        )
      );
    };

    const AuthScreen = () => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [displayName, setDisplayName] = useState('');
      const [inviteCode, setInviteCode] = useState('');
      const [showPassword, setShowPassword] = useState(false);
      const [error, setError] = useState('');

      const handleAuth = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (isLogin) {
            await signInWithEmailAndPassword(auth, email, password);
          } else {
            if (inviteCode !== SECRET_INVITE_CODE) {
              setError('招待コードが正しくありません。');
              return;
            }
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName });
            await sendEmailVerification(userCredential.user);
          }
        } catch (err) {
          setError(getFriendlyErrorMessage(err.code));
        }
      };

      const getFriendlyErrorMessage = (code) => {
        switch (code) {
          case 'auth/invalid-email':
            return '有効なメールアドレスを入力してください。';
          case 'auth/user-not-found':
          case 'auth/wrong-password':
          case 'auth/invalid-credential':
            return 'メールアドレスまたはパスワードが間違っています。';
          case 'auth/email-already-in-use':
            return 'このメールアドレスは既に使用されています。';
          case 'auth/weak-password':
            return 'パスワードは6文字以上で入力してください。';
          case 'auth/user-disabled':
            return 'このアカウントは無効になっています。管理者にお問い合わせください。';
          case 'auth/operation-not-allowed':
            return 'このログイン方法は許可されていません。Firebaseの設定を確認してください。';
          default:
            console.error('Authentication Error Code:', code);
            return '認証に失敗しました。設定を確認するか、時間をおいて再度お試しください。';
        }
      };

      return (
        React.createElement('div', { className: 'flex items-center justify-center min-h-screen bg-gray-100' },
          React.createElement('div', { className: 'w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg' },
            React.createElement('div', { className: 'text-center' },
              React.createElement('img', { src: 'https://i.ibb.co/XZyfhHZn/image.png', alt: 'JAA Logo', className: 'w-24 mx-auto mb-4' }),
              React.createElement('h2', { className: 'text-3xl font-bold text-gray-800' }, 'ニュース管理システム'),
              React.createElement('p', { className: 'text-gray-500' }, isLogin ? 'ログイン' : '新規アカウント登録')
            ),
            React.createElement('form', { onSubmit: handleAuth, className: 'space-y-6' },
              !isLogin && React.createElement('input', { type: 'text', value: displayName, onChange: e => setDisplayName(e.target.value), placeholder: '担当者名', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
              React.createElement('input', { type: 'email', value: email, onChange: e => setEmail(e.target.value), placeholder: 'メールアドレス', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
              React.createElement('div', { className: 'relative' },
                React.createElement('input', { type: showPassword ? 'text' : 'password', value: password, onChange: e => setPassword(e.target.value), placeholder: 'パスワード', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
                React.createElement('button', { type: 'button', onClick: () => setShowPassword(!showPassword), className: 'absolute inset-y-0 right-0 flex items-center px-3 text-gray-500', 'aria-label': showPassword ? 'パスワードを隠す' : 'パスワードを表示' },
                  showPassword
                    ? React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m0 0l-2.14 2.14' })
                      )
                    : React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }),
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' })
                      )
                )
              ),
              !isLogin && React.createElement('input', { type: 'text', value: inviteCode, onChange: e => setInviteCode(e.target.value), placeholder: '招待コード', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
              error && React.createElement('p', { className: 'text-red-500 text-sm text-center' }, error),
              React.createElement('button', { type: 'submit', className: 'w-full py-3 font-bold text-white bg-orange-500 rounded-md hover:bg-orange-600 transition-colors duration-300' }, isLogin ? 'ログイン' : '登録する')
            ),
            React.createElement('p', { className: 'text-sm text-center text-gray-600' },
              isLogin ? 'アカウントをお持ちでないですか？' : 'すでにアカウントをお持ちですか？',
              React.createElement('button', { onClick: () => { setIsLogin(!isLogin); setError(''); }, className: 'ml-1 font-bold text-orange-500 hover:underline' }, isLogin ? '登録する' : 'ログイン')
            )
          )
        )
      );
    };

    const ArticleEditor = ({ article, onDone }) => {
      const [title, setTitle] = useState(article?.title || '');
      const [content, setContent] = useState(article?.content || '');
      const [category, setCategory] = useState(article?.category || 'お知らせ');
      const [status, setStatus] = useState(article?.status || 'draft');
      const [isSubmitting, setIsSubmitting] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
          const data = {
            title, content, category, status,
            [article?.id ? 'updatedAt' : 'createdAt']: serverTimestamp()
          };
          
          let articleId;
          if (article?.id) {
            await updateDoc(doc(db, 'news', article.id), data);
            articleId = article.id;
          } else {
            const docRef = await addDoc(collection(db, 'news'), data);
            articleId = docRef.id;
          }
          
          // 保存成功メッセージ
          const action = article?.id ? '更新' : '作成';
          alert(`記事を${action}しました！`);
          
          // 統合記事管理システムとの同期（公開・下書き問わず）
          await syncToUnifiedArticleManager(articleId, data, action);
          
          // ニュース更新通知
          await notifyNewsUpdate(action, articleId, { ...data, id: articleId });
          
          // 成功メッセージ
          const successMessage = status === 'published' 
            ? `記事を${action}しました！他のページにも即座に反映されます。`
            : `記事を${action}しました！（下書きとして保存）`;
          alert(successMessage);
          
          onDone();
        } catch (e) {
          console.error(e);
          alert('保存に失敗しました。');
        } finally {
          setIsSubmitting(false);
        }
      };

      return (
        React.createElement('div', { className: 'bg-white p-8 rounded-xl shadow-lg' },
          React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 mb-6' }, article?.id ? '記事を編集' : '新しいニュースを作成'),
          React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-6' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'タイトル'),
              React.createElement('input', { type: 'text', value: title, onChange: e => setTitle(e.target.value), className: 'w-full p-3 border border-gray-300 rounded-md', required: true })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'カテゴリ'),
              React.createElement('select', { value: category, onChange: e => setCategory(e.target.value), className: 'w-full p-3 border border-gray-300 rounded-md bg-white' },
                React.createElement('option', { value: 'お知らせ' }, 'お知らせ'),
                React.createElement('option', { value: 'プレスリリース' }, 'プレスリリース'),
                React.createElement('option', { value: 'イベント' }, 'イベント'),
                React.createElement('option', { value: 'パートナーシップ' }, 'パートナーシップ'),
                React.createElement('option', { value: '技術情報' }, '技術情報'),
                React.createElement('option', { value: 'その他' }, 'その他')
              )
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, '内容'),
              React.createElement(RichTextEditor, { value: content, onChange: setContent })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'ステータス'),
              React.createElement('div', { className: 'flex items-center space-x-4' },
                React.createElement('label', { className: 'flex items-center' },
                  React.createElement('input', { type: 'radio', name: 'status', value: 'draft', checked: status === 'draft', onChange: e => setStatus(e.target.value), className: 'h-4 w-4 text-orange-600 border-gray-300' }),
                  React.createElement('span', { className: 'ml-2 text-gray-700' }, '下書き')
                ),
                React.createElement('label', { className: 'flex items-center' },
                  React.createElement('input', { type: 'radio', name: 'status', value: 'published', checked: status === 'published', onChange: e => setStatus(e.target.value), className: 'h-4 w-4 text-orange-600 border-gray-300' }),
                  React.createElement('span', { className: 'ml-2 text-gray-800' }, '公開')
                )
              )
            ),
            React.createElement('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4' },
              React.createElement('div', { className: 'flex items-start' },
                React.createElement('svg', { className: 'w-5 h-5 text-blue-500 mt-0.5 mr-2', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
                ),
                React.createElement('div', { className: 'text-sm text-blue-700' },
                  React.createElement('p', { className: 'font-medium' }, '公開設定について'),
                  React.createElement('p', { className: 'mt-1' }, 
                    '「公開」に設定すると、記事が即座にindex.html、news.html、news-detail.htmlに反映されます。',
                    React.createElement('br'),
                    '「下書き」の場合は、管理者のみが閲覧できます。'
                  )
                )
              )
            ),
            React.createElement('div', { className: 'flex justify-end space-x-4 pt-4' },
              React.createElement('button', { type: 'button', onClick: onDone, className: 'px-6 py-2 font-bold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300' }, 'キャンセル'),
              React.createElement('button', { type: 'submit', disabled: isSubmitting, className: 'px-6 py-2 font-bold text-white bg-orange-500 rounded-lg hover:bg-orange-600 disabled:bg-gray-400' }, isSubmitting ? '保存中...' : '保存する')
            )
          )
        )
      );
    };

    const Dashboard = ({ user }) => {
      const [articles, setArticles] = useState([]);
      const [editingArticle, setEditingArticle] = useState(null);
      
      const fetchArticles = async () => {
        const qy = query(collection(db, 'news'), orderBy('createdAt', 'desc'));
        const qs = await getDocs(qy);
        setArticles(qs.docs.map(d => ({ id: d.id, ...d.data() })));
      };
      
      useEffect(() => { fetchArticles(); }, []);
      
      const handleDelete = async (id) => {
        if (!confirm('この記事を削除しますか？')) return;
        try {
          await deleteDoc(doc(db, 'news', id));
          
          // 統合記事管理システムとの同期
          if (typeof window.unifiedArticleManager !== 'undefined') {
            await window.unifiedArticleManager.deleteArticle(id);
          }
          
          // ローカルストレージからも削除
          const storageKey = 'jaa-unified-articles';
          const existingArticles = JSON.parse(localStorage.getItem(storageKey) || '[]');
          const filteredArticles = existingArticles.filter(a => a.id !== id);
          localStorage.setItem(storageKey, JSON.stringify(filteredArticles));
          
          // ニュース更新通知
          await notifyNewsUpdate('delete', id, { id });
          
          fetchArticles();
        } catch (error) {
          console.error('記事削除エラー:', error);
          alert('記事の削除に失敗しました。');
        }
      };
      return (
        React.createElement('div', null,
          React.createElement('header', { className: 'bg-white shadow-md' },
            React.createElement('div', { className: 'container mx-auto px-6 py-4 flex justify-between items-center' },
              React.createElement('h1', { className: 'text-xl font-bold text-gray-800' }, 'JAAニュース管理システム'),
              React.createElement('div', null,
                React.createElement('span', { className: 'text-gray-600 mr-4' }, `ようこそ, ${user.displayName || user.email} さん`),
                React.createElement('button', { onClick: () => signOut(auth), className: 'font-bold text-orange-500 hover:underline' }, 'ログアウト')
              )
            )
          ),
          React.createElement('main', { className: 'container mx-auto p-6' },
            editingArticle
              ? React.createElement(ArticleEditor, { article: editingArticle, onDone: () => { setEditingArticle(null); fetchArticles(); } })
              : React.createElement('div', null,
                  React.createElement('div', { className: 'flex space-x-4 mb-6' },
                    React.createElement('button', { onClick: () => setEditingArticle({ title: '', content: '', category: 'お知らせ', status: 'draft' }), className: 'px-6 py-3 font-bold text-white bg-orange-500 rounded-lg hover:bg-orange-600 shadow-lg' }, '＋ 新しいニュースを投稿'),
                    React.createElement('button', { onClick: createSampleArticles, className: 'px-6 py-3 font-bold text-white bg-blue-500 rounded-lg hover:bg-blue-600 shadow-lg' }, '📝 サンプル記事を作成')
                  ),
                  React.createElement('div', { className: 'bg-white rounded-xl shadow-lg overflow-hidden' },
                    React.createElement('ul', { className: 'divide-y divide-gray-200' },
                      articles.length > 0 ? articles.map(a => (
                        React.createElement('li', { key: a.id, className: 'p-4 flex justify-between items-center hover:bg-gray-50' },
                          React.createElement('div', null,
                            React.createElement('h3', { className: 'font-bold text-lg text-gray-800' }, a.title),
                            React.createElement('div', { className: 'text-sm text-gray-500 mt-1 flex items-center space-x-4' },
                              React.createElement('span', null, a.createdAt?.toDate?.().toLocaleDateString('ja-JP') || ''),
                              React.createElement('span', { className: `px-2 py-0.5 text-xs font-semibold rounded-full ${a.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}` }, a.status === 'published' ? '公開中' : '下書き'),
                              React.createElement('span', { className: 'bg-blue-100 text-blue-800 px-2 py-0.5 text-xs font-semibold rounded-full' }, a.category || 'カテゴリなし')
                            )
                          ),
                          React.createElement('div', { className: 'flex space-x-2' },
                            React.createElement('button', { onClick: () => setEditingArticle(a), className: 'px-3 py-1 text-sm font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600' }, '編集'),
                            React.createElement('button', { onClick: () => handleDelete(a.id), className: 'px-3 py-1 text-sm font-bold text-white bg-red-500 rounded-md hover:bg-red-600' }, '削除')
                          )
                        )
                      )) : React.createElement('p', { className: 'p-4 text-gray-500' }, '投稿されたニュースはありません。')
                    )
                  )
                )
          )
        )
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        const unsub = onAuthStateChanged(auth, async (u) => {
          if (u) {
            await u.reload();
            setUser(auth.currentUser);
          } else {
            setUser(null);
          }
          setLoading(false);
        });
        return () => unsub();
      }, []);
      if (loading) return React.createElement(LoadingScreen);
      if (user && !user.emailVerified) return React.createElement(EmailVerificationScreen, { user });
      return React.createElement('div', { className: 'bg-gray-50 min-h-screen font-sans' }, user ? React.createElement(Dashboard, { user }) : React.createElement(AuthScreen));
    };

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>