<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ニュース管理コンソール</title>
  <link rel="icon" href="https://i.ibb.co/6R5nX1YH/Rogo.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    // React
    import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18';
    import { createRoot } from 'https://esm.sh/react-dom@18/client';

    // Firebase (v9 ESM)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      onAuthStateChanged, updateProfile, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyDUm0XzV9wPIHJSTsKiJ9LXqjlIA81l1Rc",
      authDomain: "jaa-hp.firebaseapp.com",
      projectId: "jaa-hp",
      storageBucket: "jaa-hp.appspot.com",
      messagingSenderId: "549447513177",
      appId: "1:549447513177:web:2f2fc2f9bfe0ddd29d6d48",
      measurementId: "G-JLRH848YQS"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'asia-northeast1');

    const SECRET_INVITE_CODE = "JAA-NEWS-ADMIN";

    // --- RichTextEditor（提示コードの簡易版を内蔵） ---
    const RichTextEditor = ({ value, onChange }) => {
      const editorRef = useRef(null);
      const handleFormat = (command, value = null) => {
        document.execCommand(command, false, value);
        editorRef.current?.focus();
      };
      const handleInput = () => onChange(editorRef.current.innerHTML);
      return (
        React.createElement('div', { className: 'border border-gray-300 rounded-md' },
          React.createElement('div', { className: 'flex items-center p-2 border-b bg-gray-50 space-x-2' },
            React.createElement('button', { type: 'button', onMouseDown: e => { e.preventDefault(); handleFormat('formatBlock', '<h2>'); }, className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' }, 'H2'),
            React.createElement('button', { type: 'button', onMouseDown: e => { e.preventDefault(); handleFormat('bold'); }, className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' }, '太字'),
            React.createElement('button', { type: 'button', onMouseDown: e => { e.preventDefault(); handleFormat('underline'); }, className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' }, '下線'),
            React.createElement('button', { type: 'button', onMouseDown: e => { e.preventDefault(); handleFormat('insertUnorderedList'); }, className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' }, '・箇条書き'),
            React.createElement('button', { type: 'button', onMouseDown: e => { e.preventDefault(); handleFormat('insertOrderedList'); }, className: 'px-3 py-1 border border-gray-300 bg-white hover:bg-gray-100 rounded-md text-sm font-medium' }, '1. 数字リスト')
          ),
          React.createElement('div', {
            ref: editorRef,
            className: 'w-full h-64 p-3 focus:outline-none overflow-y-auto',
            contentEditable: true,
            onInput: handleInput,
            dangerouslySetInnerHTML: { __html: value || '' }
          })
        )
      );
    };

    const LoadingScreen = () => (
      React.createElement('div', { className: 'flex items-center justify-center min-h-screen bg-gray-50' },
        React.createElement('div', { className: 'flex flex-col items-center' },
          React.createElement('div', { className: 'animate-spin rounded-full h-16 w-16 border-b-4 border-orange-500' }),
          React.createElement('p', { className: 'mt-4 text-lg text-gray-600' }, '読み込み中...')
        )
      )
    );

    // メール認証画面（提示コード準拠）
    const EmailVerificationScreen = ({ user }) => {
      const [resendDisabled, setResendDisabled] = useState(false);
      const [countdown, setCountdown] = useState(15 * 60);
      const [message, setMessage] = useState('');
      const timerRef = useRef(null);

      useEffect(() => {
        timerRef.current = setInterval(() => {
          setCountdown(prev => {
            if (prev <= 1) {
              clearInterval(timerRef.current);
              return 0;
            }
            return prev - 1;
          });
        }, 1000);
        return () => clearInterval(timerRef.current);
      }, []);

      const handleResendEmail = async () => {
        setResendDisabled(true);
        setMessage('');
        try {
          try {
            const callSend = httpsCallable(functions, 'sendVerificationEmail');
            await callSend({ email: user.email, displayName: user.displayName });
          } catch (e) {
            await sendEmailVerification(user);
          }
          setMessage('確認メールを再送信しました。');
        } catch (error) {
          setMessage('メールの送信に失敗しました。時間をおいて再度お試しください。');
          console.error(error);
        }
        setTimeout(() => setResendDisabled(false), 60000);
      };

      const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
      };

      return (
        React.createElement('div', { className: 'flex items-center justify-center min-h-screen bg-gray-100' },
          React.createElement('div', { className: 'w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg text-center' },
            React.createElement('h2', { className: 'text-2xl font-bold text-gray-800' }, 'メールアドレスの確認'),
            React.createElement('p', { className: 'text-gray-600' },
              React.createElement('strong', { className: 'text-orange-600' }, user.email),
              ' 宛に確認メールを送信しました。メール内のリンクをクリックして、アカウント登録を完了してください。'
            ),
            countdown > 0
              ? React.createElement('p', { className: 'text-lg font-bold text-gray-700' }, 'リンクの有効期限: ', React.createElement('span', { className: 'text-red-500' }, formatTime(countdown)))
              : React.createElement('p', { className: 'text-red-500 font-bold' }, '認証リンクの有効期限が切れました。再送してください。'),
            React.createElement('button', { onClick: handleResendEmail, disabled: resendDisabled, className: 'w-full py-3 font-bold text-white bg-orange-500 rounded-md hover:bg-orange-600 transition-colors duration-300 disabled:bg-gray-400' }, resendDisabled ? '60秒後に再送可能' : '確認メールを再送する'),
            message && React.createElement('p', { className: 'text-green-600 text-sm' }, message),
            React.createElement('p', { className: 'text-sm text-gray-500 pt-4' }, '認証が完了したら、ページをリロードしてください。'),
            React.createElement('button', { onClick: () => signOut(auth), className: 'mt-2 text-sm text-gray-500 hover:underline' }, 'ログアウト')
          )
        )
      );
    };

    const AuthScreen = () => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [displayName, setDisplayName] = useState('');
      const [inviteCode, setInviteCode] = useState('');
      const [showPassword, setShowPassword] = useState(false);
      const [error, setError] = useState('');

      const handleAuth = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (isLogin) {
            await signInWithEmailAndPassword(auth, email, password);
          } else {
            if (inviteCode !== SECRET_INVITE_CODE) {
              setError('招待コードが正しくありません。');
              return;
            }
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName });
            try {
              const callSend = httpsCallable(functions, 'sendVerificationEmail');
              await callSend({ email: userCredential.user.email, displayName });
            } catch (e) {
              await sendEmailVerification(userCredential.user);
            }
          }
        } catch (err) {
          setError(getFriendlyErrorMessage(err.code));
        }
      };

      const getFriendlyErrorMessage = (code) => {
        switch (code) {
          case 'auth/invalid-email':
            return '有効なメールアドレスを入力してください。';
          case 'auth/user-not-found':
          case 'auth/wrong-password':
          case 'auth/invalid-credential':
            return 'メールアドレスまたはパスワードが間違っています。';
          case 'auth/email-already-in-use':
            return 'このメールアドレスは既に使用されています。';
          case 'auth/weak-password':
            return 'パスワードは6文字以上で入力してください。';
          case 'auth/user-disabled':
            return 'このアカウントは無効になっています。管理者にお問い合わせください。';
          case 'auth/operation-not-allowed':
            return 'このログイン方法は許可されていません。Firebaseの設定を確認してください。';
          default:
            console.error('Authentication Error Code:', code);
            return '認証に失敗しました。設定を確認するか、時間をおいて再度お試しください。';
        }
      };

      return (
        React.createElement('div', { className: 'flex items-center justify-center min-h-screen bg-gray-100' },
          React.createElement('div', { className: 'w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg' },
            React.createElement('div', { className: 'text-center' },
              React.createElement('img', { src: 'https://i.ibb.co/XZyfhHZn/image.png', alt: 'JAA Logo', className: 'w-24 mx-auto mb-4' }),
              React.createElement('h2', { className: 'text-3xl font-bold text-gray-800' }, 'ニュース管理システム'),
              React.createElement('p', { className: 'text-gray-500' }, isLogin ? 'ログイン' : '新規アカウント登録')
            ),
            React.createElement('form', { onSubmit: handleAuth, className: 'space-y-6' },
              !isLogin && React.createElement('input', { type: 'text', value: displayName, onChange: e => setDisplayName(e.target.value), placeholder: '担当者名', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
              React.createElement('input', { type: 'email', value: email, onChange: e => setEmail(e.target.value), placeholder: 'メールアドレス', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
              React.createElement('div', { className: 'relative' },
                React.createElement('input', { type: showPassword ? 'text' : 'password', value: password, onChange: e => setPassword(e.target.value), placeholder: 'パスワード', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
                React.createElement('button', { type: 'button', onClick: () => setShowPassword(!showPassword), className: 'absolute inset-y-0 right-0 flex items-center px-3 text-gray-500', 'aria-label': showPassword ? 'パスワードを隠す' : 'パスワードを表示' },
                  showPassword
                    ? React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m0 0l-2.14 2.14' })
                      )
                    : React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }),
                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' })
                      )
                )
              ),
              !isLogin && React.createElement('input', { type: 'text', value: inviteCode, onChange: e => setInviteCode(e.target.value), placeholder: '招待コード', className: 'w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500', required: true }),
              error && React.createElement('p', { className: 'text-red-500 text-sm text-center' }, error),
              React.createElement('button', { type: 'submit', className: 'w-full py-3 font-bold text-white bg-orange-500 rounded-md hover:bg-orange-600 transition-colors duration-300' }, isLogin ? 'ログイン' : '登録する')
            ),
            React.createElement('p', { className: 'text-sm text-center text-gray-600' },
              isLogin ? 'アカウントをお持ちでないですか？' : 'すでにアカウントをお持ちですか？',
              React.createElement('button', { onClick: () => { setIsLogin(!isLogin); setError(''); }, className: 'ml-1 font-bold text-orange-500 hover:underline' }, isLogin ? '登録する' : 'ログイン')
            )
          )
        )
      );
    };

    const ArticleEditor = ({ article, onDone }) => {
      const [title, setTitle] = useState(article?.title || '');
      const [content, setContent] = useState(article?.content || '');
      const [category, setCategory] = useState(article?.category || 'お知らせ');
      const [status, setStatus] = useState(article?.status || 'draft');
      const [isSubmitting, setIsSubmitting] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
          const data = {
            title, content, category, status,
            [article?.id ? 'updatedAt' : 'createdAt']: serverTimestamp()
          };
          if (article?.id) {
            await updateDoc(doc(db, 'news', article.id), data);
          } else {
            await addDoc(collection(db, 'news'), data);
          }
          alert('記事を保存しました！');
          onDone();
        } catch (e) {
          console.error(e);
          alert('保存に失敗しました。');
        } finally {
          setIsSubmitting(false);
        }
      };

      return (
        React.createElement('div', { className: 'bg-white p-8 rounded-xl shadow-lg' },
          React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 mb-6' }, article?.id ? '記事を編集' : '新しいニュースを作成'),
          React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-6' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'タイトル'),
              React.createElement('input', { type: 'text', value: title, onChange: e => setTitle(e.target.value), className: 'w-full p-3 border border-gray-300 rounded-md', required: true })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'カテゴリ'),
              React.createElement('select', { value: category, onChange: e => setCategory(e.target.value), className: 'w-full p-3 border border-gray-300 rounded-md bg-white' },
                React.createElement('option', { value: 'お知らせ' }, 'お知らせ'),
                React.createElement('option', { value: 'プレスリリース' }, 'プレスリリース'),
                React.createElement('option', { value: 'メディア掲載' }, 'メディア掲載'),
                React.createElement('option', { value: 'イベント' }, 'イベント')
              )
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, '内容'),
              React.createElement(RichTextEditor, { value: content, onChange: setContent })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'ステータス'),
              React.createElement('div', { className: 'flex items-center space-x-4' },
                React.createElement('label', { className: 'flex items-center' },
                  React.createElement('input', { type: 'radio', name: 'status', value: 'draft', checked: status === 'draft', onChange: e => setStatus(e.target.value), className: 'h-4 w-4 text-orange-600 border-gray-300' }),
                  React.createElement('span', { className: 'ml-2 text-gray-700' }, '下書き')
                ),
                React.createElement('label', { className: 'flex items-center' },
                  React.createElement('input', { type: 'radio', name: 'status', value: 'published', checked: status === 'published', onChange: e => setStatus(e.target.value), className: 'h-4 w-4 text-orange-600 border-gray-300' }),
                  React.createElement('span', { className: 'ml-2 text-gray-700' }, '公開')
                )
              )
            ),
            React.createElement('div', { className: 'flex justify-end space-x-4 pt-4' },
              React.createElement('button', { type: 'button', onClick: onDone, className: 'px-6 py-2 font-bold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300' }, 'キャンセル'),
              React.createElement('button', { type: 'submit', disabled: isSubmitting, className: 'px-6 py-2 font-bold text-white bg-orange-500 rounded-lg hover:bg-orange-600 disabled:bg-gray-400' }, isSubmitting ? '保存中...' : '保存する')
            )
          )
        )
      );
    };

    const Dashboard = ({ user }) => {
      const [articles, setArticles] = useState([]);
      const [editingArticle, setEditingArticle] = useState(null);
      const fetchArticles = async () => {
        const qy = query(collection(db, 'news'), orderBy('createdAt', 'desc'));
        const qs = await getDocs(qy);
        setArticles(qs.docs.map(d => ({ id: d.id, ...d.data() })));
      };
      useEffect(() => { fetchArticles(); }, []);
      const handleDelete = async (id) => {
        if (!confirm('この記事を削除しますか？')) return;
        await deleteDoc(doc(db, 'news', id));
        fetchArticles();
      };
      return (
        React.createElement('div', null,
          React.createElement('header', { className: 'bg-white shadow-md' },
            React.createElement('div', { className: 'container mx-auto px-6 py-4 flex justify-between items-center' },
              React.createElement('h1', { className: 'text-xl font-bold text-gray-800' }, 'JAAニュース管理システム'),
              React.createElement('div', null,
                React.createElement('span', { className: 'text-gray-600 mr-4' }, `ようこそ, ${user.displayName || user.email} さん`),
                React.createElement('button', { onClick: () => signOut(auth), className: 'font-bold text-orange-500 hover:underline' }, 'ログアウト')
              )
            )
          ),
          React.createElement('main', { className: 'container mx-auto p-6' },
            editingArticle
              ? React.createElement(ArticleEditor, { article: editingArticle, onDone: () => { setEditingArticle(null); fetchArticles(); } })
              : React.createElement('div', null,
                  React.createElement('button', { onClick: () => setEditingArticle({ title: '', content: '', category: 'お知らせ', status: 'draft' }), className: 'mb-6 px-6 py-3 font-bold text-white bg-orange-500 rounded-lg hover:bg-orange-600 shadow-lg' }, '＋ 新しいニュースを投稿'),
                  React.createElement('div', { className: 'bg-white rounded-xl shadow-lg overflow-hidden' },
                    React.createElement('ul', { className: 'divide-y divide-gray-200' },
                      articles.length > 0 ? articles.map(a => (
                        React.createElement('li', { key: a.id, className: 'p-4 flex justify-between items-center hover:bg-gray-50' },
                          React.createElement('div', null,
                            React.createElement('h3', { className: 'font-bold text-lg text-gray-800' }, a.title),
                            React.createElement('div', { className: 'text-sm text-gray-500 mt-1 flex items-center space-x-4' },
                              React.createElement('span', null, a.createdAt?.toDate?.().toLocaleDateString('ja-JP') || ''),
                              React.createElement('span', { className: `px-2 py-0.5 text-xs font-semibold rounded-full ${a.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}` }, a.status === 'published' ? '公開中' : '下書き'),
                              React.createElement('span', { className: 'bg-blue-100 text-blue-800 px-2 py-0.5 text-xs font-semibold rounded-full' }, a.category || 'カテゴリなし')
                            )
                          ),
                          React.createElement('div', { className: 'flex space-x-2' },
                            React.createElement('button', { onClick: () => setEditingArticle(a), className: 'px-3 py-1 text-sm font-bold text-white bg-blue-500 rounded-md hover:bg-blue-600' }, '編集'),
                            React.createElement('button', { onClick: () => handleDelete(a.id), className: 'px-3 py-1 text-sm font-bold text-white bg-red-500 rounded-md hover:bg-red-600' }, '削除')
                          )
                        )
                      )) : React.createElement('p', { className: 'p-4 text-gray-500' }, '投稿されたニュースはありません。')
                    )
                  )
                )
          )
        )
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        const unsub = onAuthStateChanged(auth, async (u) => {
          if (u) {
            await u.reload();
            setUser(auth.currentUser);
          } else {
            setUser(null);
          }
          setLoading(false);
        });
        return () => unsub();
      }, []);
      if (loading) return React.createElement(LoadingScreen);
      if (user && !user.emailVerified) return React.createElement(EmailVerificationScreen, { user });
      return React.createElement('div', { className: 'bg-gray-50 min-h-screen font-sans' }, user ? React.createElement(Dashboard, { user }) : React.createElement(AuthScreen));
    };

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>


